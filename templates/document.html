<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор документов - Заполнение</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="logo">
                <i class="fas fa-file-contract"></i>
                <span>ДокументГен</span>
            </a>
            <div class="nav-links">
                <a href="/"><i class="fas fa-home"></i> Главная</a>
                <a href="/templates"><i class="fas fa-file-alt"></i> Шаблоны</a>
                <a href="#" onclick="goBack()"><i class="fas fa-arrow-left"></i> Назад</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-edit"></i> Заполнение документа</h1>
            <p id="templateTitle" class="subtitle">Загрузка шаблона...</p>
        </div>

        <div class="document-container">
            <div class="document-form">
                <form id="documentForm">
                    <div id="loading" class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Загрузка полей документа...
                    </div>
                    <div id="formFields" style="display: none;">
                        <!-- Поля формы загрузятся через JavaScript -->
                    </div>
                    <div id="formActions" class="form-actions" style="display: none;">
                        <button type="button" class="btn btn-primary" onclick="generateDocument()">
                            <i class="fas fa-file-download"></i> Создать документ
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">
                            <i class="fas fa-eraser"></i> Очистить форму
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="goBack()">
                            <i class="fas fa-times"></i> Отмена
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="document-preview">
                <h3><i class="fas fa-eye"></i> Предварительный просмотр</h3>
                <div class="preview-content" id="previewContent">
                    <p>Заполните поля формы для просмотра данных</p>
                </div>
                <div class="preview-info">
                    <p><i class="fas fa-info-circle"></i> Все обязательные поля отмечены звездочкой (*)</p>
                    <p><i class="fas fa-save"></i> Документ будет сохранен в системе после создания</p>
                </div>
            </div>
        </div>

        <div id="resultMessage" class="result-message" style="display: none;">
            <!-- Сообщение о результате загрузятся через JS -->
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>© 2024 Генератор документов. Все права защищены.</p>
        </div>
    </footer>

    <script src="/static/script.js"></script>
    <script>
        const templateId = { template_id };
        let templateFields = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadTemplateInfo();
            loadTemplateFields();
            
            // Обновляем превью при изменении формы
            document.getElementById('documentForm').addEventListener('input', function() {
                updatePreview();
            });
        });

        function loadTemplateInfo() {
            fetch(`/api/templates/${templateId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('templateTitle').textContent = data.template.name;
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки информации о шаблоне:', error);
                });
        }

        function loadTemplateFields() {
            fetch(`/api/templates/${templateId}/fields`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    
                    if (data.success) {
                        templateFields = data.fields;
                        renderFormFields();
                        document.getElementById('formFields').style.display = 'block';
                        document.getElementById('formActions').style.display = 'block';
                        updatePreview();
                    } else {
                        showError('Не удалось загрузить поля шаблона');
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки полей шаблона:', error);
                    document.getElementById('loading').style.display = 'none';
                    showError('Ошибка загрузки полей шаблона');
                });
        }

        function renderFormFields() {
            const formFields = document.getElementById('formFields');
            formFields.innerHTML = '';
            
            templateFields.forEach(field => {
                const fieldElement = createFieldElement(field);
                formFields.appendChild(fieldElement);
            });
        }

        function createFieldElement(field) {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'form-group';
            
            const label = document.createElement('label');
            label.htmlFor = field.key;
            label.textContent = field.label;
            if (field.required) {
                label.innerHTML += ' <span class="required">*</span>';
            }
            
            fieldDiv.appendChild(label);
            
            let input;
            
            switch(field.type) {
                case 'textarea':
                    input = document.createElement('textarea');
                    input.rows = 4;
                    break;
                case 'select':
                    input = document.createElement('select');
                    if (field.options && Array.isArray(field.options)) {
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = '-- Выберите --';
                        input.appendChild(defaultOption);
                        
                        field.options.forEach(option => {
                            const optionElement = document.createElement('option');
                            optionElement.value = option;
                            optionElement.textContent = option;
                            input.appendChild(optionElement);
                        });
                    }
                    break;
                case 'date':
                    input = document.createElement('input');
                    input.type = 'date';
                    break;
                case 'number':
                    input = document.createElement('input');
                    input.type = 'number';
                    if (field.min !== undefined) input.min = field.min;
                    if (field.max !== undefined) input.max = field.max;
                    break;
                case 'boolean':
                    input = document.createElement('div');
                    input.className = 'checkbox-group';
                    input.innerHTML = `
                        <label class="checkbox-label">
                            <input type="checkbox" id="${field.key}" name="${field.key}">
                            <span>Да</span>
                        </label>
                    `;
                    fieldDiv.appendChild(input);
                    return fieldDiv;
                default:
                    input = document.createElement('input');
                    input.type = 'text';
            }
            
            if (field.type !== 'boolean') {
                input.id = field.key;
                input.name = field.key;
                input.className = 'form-control';
                
                if (field.placeholder) {
                    input.placeholder = field.placeholder;
                }
                
                if (field.required) {
                    input.required = true;
                }
                
                fieldDiv.appendChild(input);
            }
            
            return fieldDiv;
        }

        function generateDocument() {
            const form = document.getElementById('documentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const formData = {};
            templateFields.forEach(field => {
                const input = document.getElementById(field.key) || 
                             document.querySelector(`[name="${field.key}"]`);
                
                if (input) {
                    if (field.type === 'checkbox') {
                        formData[field.key] = input.checked ? 'Да' : 'Нет';
                    } else if (field.type === 'select') {
                        formData[field.key] = input.value;
                    } else {
                        formData[field.key] = input.value;
                    }
                }
            });
            
            // Валидация обязательных полей
            const missingFields = templateFields
                .filter(field => field.required && (!formData[field.key] || formData[field.key].trim() === ''))
                .map(field => field.label);
            
            if (missingFields.length > 0) {
                alert('Пожалуйста, заполните обязательные поля:\n' + missingFields.join('\n'));
                return;
            }
            
            const payload = {
                template_id: templateId,
                fields: formData
            };
            
            fetch('/api/documents/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess(`
                        <h3><i class="fas fa-check-circle"></i> Документ успешно создан!</h3>
                        <p>ID документа: <strong>${data.document_id}</strong></p>
                        <p>Шаблон: <strong>${data.template_name}</strong></p>
                        <p>Создан: <strong>${new Date(data.generated_at).toLocaleString()}</strong></p>
                        <button class="btn btn-primary" onclick="createAnother()">
                            <i class="fas fa-plus"></i> Создать еще один
                        </button>
                        <button class="btn btn-secondary" onclick="goBack()">
                            <i class="fas fa-arrow-left"></i> Вернуться к шаблонам
                        </button>
                    `);
                } else {
                    showError(data.error || 'Неизвестная ошибка при создании документа');
                }
            })
            .catch(error => {
                console.error('Ошибка создания документа:', error);
                showError('Ошибка при создании документа: ' + error.message);
            });
        }

        function updatePreview() {
            const formData = {};
            templateFields.forEach(field => {
                const input = document.getElementById(field.key) || 
                             document.querySelector(`[name="${field.key}"]`);
                
                if (input) {
                    let value;
                    if (field.type === 'checkbox') {
                        value = input.checked ? '✓ Да' : '✗ Нет';
                    } else if (field.type === 'select') {
                        value = input.value || '(не выбрано)';
                    } else {
                        value = input.value || '(не заполнено)';
                    }
                    formData[field.label] = value;
                }
            });
            
            const previewContent = document.getElementById('previewContent');
            if (Object.keys(formData).length === 0) {
                previewContent.innerHTML = '<p>Заполните поля формы для просмотра данных</p>';
            } else {
                previewContent.innerHTML = `
                    <h4>Заполненные данные:</h4>
                    <table class="preview-table">
                        <tbody>
                            ${Object.entries(formData).map(([label, value]) => `
                                <tr>
                                    <td><strong>${label}:</strong></td>
                                    <td>${value}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
        }

        function clearForm() {
            if (confirm('Очистить все поля формы?')) {
                templateFields.forEach(field => {
                    const input = document.getElementById(field.key) || 
                                 document.querySelector(`[name="${field.key}"]`);
                    
                    if (input) {
                        if (field.type === 'checkbox') {
                            input.checked = false;
                        } else if (field.type === 'select') {
                            input.selectedIndex = 0;
                        } else {
                            input.value = '';
                        }
                    }
                });
                
                updatePreview();
            }
        }

        function showSuccess(message) {
            const resultDiv = document.getElementById('resultMessage');
            resultDiv.className = 'result-message success';
            resultDiv.innerHTML = message;
            resultDiv.style.display = 'block';
            
            // Прокручиваем к результату
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function showError(message) {
            const resultDiv = document.getElementById('resultMessage');
            resultDiv.className = 'result-message error';
            resultDiv.innerHTML = `
                <h3><i class="fas fa-exclamation-circle"></i> Ошибка</h3>
                <p>${message}</p>
                <button class="btn btn-secondary" onclick="hideResult()">
                    <i class="fas fa-times"></i> Закрыть
                </button>
            `;
            resultDiv.style.display = 'block';
        }

        function hideResult() {
            document.getElementById('resultMessage').style.display = 'none';
        }

        function createAnother() {
            clearForm();
            document.getElementById('resultMessage').style.display = 'none';
            document.getElementById('documentForm').scrollIntoView({ behavior: 'smooth' });
        }

        function goBack() {
            window.location.href = '/templates';
        }
    </script>
</body>
</html>
